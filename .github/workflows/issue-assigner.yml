name: Issue Auto Assigner

on:
  issues:
    types: [opened, labeled]

jobs:
  assign-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write

    steps:
      - name: Auto Assign Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;

            // ì´ìŠˆ ë¼ë²¨ ê°€ì ¸ì˜¤ê¸°
            const labels = issue.labels.map(label => label.name);

            let assignees = [];

            // ë¼ë²¨ë³„ ë‹´ë‹¹ì ë§¤í•‘ (ì‹¤ì œ GitHub ì‚¬ìš©ìëª…ìœ¼ë¡œ ë³€ê²½ í•„ìš”)
            const labelToAssignee = {
              'bug': ['bug-hunter'],
              'enhancement': ['feature-developer'], 
              'documentation': ['doc-writer'],
              'backend': ['backend-team'],
              'frontend': ['frontend-team'],
              'testing': ['qa-engineer'],
              'ci-cd': ['devops-engineer'],
              'dependencies': ['maintenance-team'],
              'priority-critical': ['tech-lead'],
              'priority-high': ['senior-developer'],
              'good first issue': ['mentor']
            };

            // ë¼ë²¨ì— ë”°ë¥¸ ë‹´ë‹¹ì ê²°ì •
            for (const label of labels) {
              if (labelToAssignee[label]) {
                assignees.push(...labelToAssignee[label]);
              }
            }

            // ì¤‘ë³µ ì œê±°
            assignees = [...new Set(assignees)];

            // ì´ìŠˆ ìƒì„±ìëŠ” ì œì™¸ (ë³¸ì¸ì´ ìƒì„±í•œ ì´ìŠˆì— ë³¸ì¸ì„ í• ë‹¹í•˜ì§€ ì•ŠìŒ)
            assignees = assignees.filter(assignee => assignee !== issue.user.login);

            // ê¸°ë³¸ ë‹´ë‹¹ì ì„¤ì • (ë¼ë²¨ì´ ì—†ê±°ë‚˜ ë§¤ì¹­ë˜ëŠ” ë‹´ë‹¹ìê°€ ì—†ëŠ” ê²½ìš°)
            if (assignees.length === 0) {
              // ì´ìŠˆ ì œëª©ì´ë‚˜ ë‚´ìš©ì„ ë¶„ì„í•˜ì—¬ ë‹´ë‹¹ì ê²°ì •
              const title = issue.title.toLowerCase();
              const body = issue.body ? issue.body.toLowerCase() : '';
              
              if (title.includes('test') || body.includes('test')) {
                assignees.push('qa-engineer');
              } else if (title.includes('doc') || body.includes('documentation')) {
                assignees.push('doc-writer');
              } else if (title.includes('api') || title.includes('backend')) {
                assignees.push('backend-team');
              } else if (title.includes('ui') || title.includes('frontend')) {
                assignees.push('frontend-team');
              } else {
                // ê¸°ë³¸ ë‹´ë‹¹ì
                assignees.push('default-maintainer');
              }
            }

            // ë‹´ë‹¹ì í• ë‹¹
            if (assignees.length > 0) {
              try {
                await github.rest.issues.addAssignees({
                  owner,
                  repo,
                  issue_number: issue.number,
                  assignees: assignees.slice(0, 3) // ìµœëŒ€ 3ëª…ê¹Œì§€ë§Œ í• ë‹¹
                });
                
                console.log(`Assigned issue to: ${assignees.join(', ')}`);
                
                // í• ë‹¹ ì•Œë¦¼ ëŒ“ê¸€ ì‘ì„±
                const assignmentComment = `
                ğŸ¤– **ìë™ í• ë‹¹ ì™„ë£Œ**
                
                ì´ ì´ìŠˆê°€ ë‹¤ìŒ ë‹´ë‹¹ìì—ê²Œ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤: ${assignees.map(a => `@${a}`).join(', ')}
                
                í• ë‹¹ ê·¼ê±°:
                ${labels.length > 0 ? `- ë¼ë²¨: ${labels.join(', ')}` : '- ì´ìŠˆ ë‚´ìš© ë¶„ì„ ê²°ê³¼'}
                
                ë‹´ë‹¹ìê°€ ê³§ ê²€í† í•˜ê³  ì‘ë‹µë“œë¦¬ê² ìŠµë‹ˆë‹¤! ğŸ“‹
                `;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: assignmentComment
                });
                
              } catch (error) {
                console.log(`Error assigning issue: ${error.message}`);
                
                // í• ë‹¹ ì‹¤íŒ¨ ì‹œ ëŒ“ê¸€ë¡œ ì•Œë¦¼
                const errorComment = `
                âš ï¸ **ìë™ í• ë‹¹ ì‹¤íŒ¨**
                
                ë‹´ë‹¹ì ìë™ í• ë‹¹ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.
                ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•˜ê² ìŠµë‹ˆë‹¤.
                
                ì˜¤ë¥˜: ${error.message}
                `;
                
                await github.rest.issues.createComment({
                  owner,
                  repo,
                  issue_number: issue.number,
                  body: errorComment
                });
              }
            }
